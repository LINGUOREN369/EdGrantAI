<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="900" viewBox="0 0 1200 900">
  <defs>
    <style type="text/css"><![CDATA[
      .box { fill: #ffffff; stroke: #1f2937; stroke-width: 2; rx: 8; ry: 8; }
      .title { font-family: Arial, sans-serif; font-size: 24px; font-weight: 700; fill: #111827; }
      .label { font-family: Arial, sans-serif; font-size: 14px; fill: #111827; }
      .small { font-family: Arial, sans-serif; font-size: 12px; fill: #374151; }
      .muted { fill: #6b7280; }
      .line { stroke: #4b5563; stroke-width: 2; fill: none; }
      .dash { stroke-dasharray: 6 6; }
      marker#arrow { markerWidth: 10; markerHeight: 10; refX: 6; refY: 3; orient: auto; }
    ]]></style>
    <marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#4b5563" />
    </marker>
  </defs>

  <!-- Title -->
  <text class="title" x="600" y="36" text-anchor="middle">EdGrantAI — Data Processing Flow</text>

  <!-- A: Grant text (input) -->
  <rect class="box" x="450" y="60" width="300" height="60"/>
  <text class="label" x="600" y="95" text-anchor="middle">Grant text (input)</text>

  <!-- B: CKE -->
  <rect class="box" x="360" y="150" width="480" height="80"/>
  <text class="label" x="600" y="182" text-anchor="middle">CKE: Controlled Keyphrase Extractor</text>
  <text class="small muted" x="600" y="202" text-anchor="middle">pipeline/cke.py · OpenAI Chat</text>

  <!-- P: Prompt input -->
  <rect class="box" x="120" y="150" width="300" height="60"/>
  <text class="label" x="270" y="185" text-anchor="middle">prompts/cke_prompt_v1.txt</text>

  <!-- Connect A -> B; P -> B -->
  <line class="line" x1="600" y1="120" x2="600" y2="150" marker-end="url(#arrow)"/>
  <line class="line" x1="420" y1="180" x2="360" y2="190" marker-end="url(#arrow)"/>

  <!-- OpenAI Chat label -->
  <text class="small muted" x="610" y="145">settings.OPENAI_CHAT_MODEL</text>

  <!-- C: Extracted phrases -->
  <rect class="box" x="420" y="260" width="360" height="60"/>
  <text class="label" x="600" y="295" text-anchor="middle">Extracted phrases (JSON array)</text>
  <line class="line" x1="600" y1="230" x2="600" y2="260" marker-end="url(#arrow)"/>

  <!-- D: Canonical Mapping -->
  <rect class="box" x="330" y="350" width="540" height="100"/>
  <text class="label" x="600" y="385" text-anchor="middle">Canonical Mapping</text>
  <text class="small muted" x="600" y="405" text-anchor="middle">pipeline/canonical_mapper.py + embedding_matcher.py</text>

  <!-- T1: Taxonomy JSON -->
  <rect class="box" x="120" y="350" width="300" height="60"/>
  <text class="label" x="270" y="385" text-anchor="middle">data/taxonomy/*.json</text>

  <!-- T2: Taxonomy Embeddings JSON -->
  <rect class="box" x="840" y="350" width="300" height="60"/>
  <text class="label" x="990" y="385" text-anchor="middle">data/taxonomy/embeddings/*.json</text>

  <!-- Lines to D -->
  <line class="line" x1="600" y1="320" x2="600" y2="350" marker-end="url(#arrow)"/>
  <line class="line" x1="420" y1="380" x2="330" y2="395" marker-end="url(#arrow)"/>
  <line class="line" x1="840" y1="380" x2="870" y2="395" marker-end="url(#arrow)"/>

  <!-- OpenAI Embeddings label -->
  <text class="small muted" x="615" y="448">settings.OPENAI_EMBEDDING_MODEL</text>

  <!-- E: Canonical tags + confidence -->
  <rect class="box" x="390" y="490" width="420" height="60"/>
  <text class="label" x="600" y="525" text-anchor="middle">Canonical tags + confidence</text>
  <line class="line" x1="600" y1="450" x2="600" y2="490" marker-end="url(#arrow)"/>

  <!-- F: Grant Profile Builder -->
  <rect class="box" x="320" y="590" width="560" height="80"/>
  <text class="label" x="600" y="622" text-anchor="middle">Grant Profile Builder</text>
  <text class="small muted" x="600" y="642" text-anchor="middle">pipeline/grant_profile_builder.py</text>

  <!-- V: Schema version input -->
  <rect class="box" x="120" y="590" width="340" height="60"/>
  <text class="label" x="290" y="625" text-anchor="middle">data/taxonomy/schema_version.json</text>

  <!-- Lines into F from C, E, V -->
  <line class="line" x1="600" y1="320" x2="600" y2="590" marker-end="url(#arrow)"/>
  <line class="line" x1="600" y1="550" x2="600" y2="590" marker-end="url(#arrow)"/>
  <line class="line" x1="460" y1="620" x2="520" y2="630" marker-end="url(#arrow)"/>

  <!-- G: Grant profile dict -->
  <rect class="box" x="430" y="720" width="340" height="60"/>
  <text class="label" x="600" y="755" text-anchor="middle">Grant profile (dict)</text>
  <line class="line" x1="600" y1="670" x2="600" y2="720" marker-end="url(#arrow)"/>

  <!-- H: Output file path -->
  <rect class="box" x="340" y="800" width="520" height="60"/>
  <text class="label" x="600" y="835" text-anchor="middle">data/processed_grants/{grant_id}_profile.json</text>
  <line class="line" x1="600" y1="780" x2="600" y2="800" marker-end="url(#arrow)"/>

  <!-- Offline Prep: Embedding creation -->
  <rect class="box" x="840" y="260" width="300" height="80"/>
  <text class="label" x="990" y="292" text-anchor="middle">Embed canonical tags</text>
  <text class="small muted" x="990" y="312" text-anchor="middle">embedding_matcher.embed_canonical_tags</text>
  <line class="line" x1="990" y1="340" x2="990" y2="350" marker-end="url(#arrow)"/>

  <!-- Config & Env -->
  <rect class="box" x="60" y="740" width="320" height="120"/>
  <text class="label" x="220" y="772" text-anchor="middle">Config & Env</text>
  <text class="small muted" x="220" y="792" text-anchor="middle">pipeline/config.py · loads .env</text>
  <text class="small muted" x="220" y="812" text-anchor="middle">Defines paths & model names</text>
  <!-- Dashed influence lines -->
  <line class="line dash" x1="380" y1="190" x2="360" y2="190" marker-end="url(#arrow)"/>
  <line class="line dash" x1="380" y1="400" x2="330" y2="400" marker-end="url(#arrow)"/>
  <line class="line dash" x1="380" y1="630" x2="320" y2="630" marker-end="url(#arrow)"/>

</svg>

